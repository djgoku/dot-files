#!/usr/bin/env zsh
#MISE description="Run Emacs config smoke tests"
#MISE depends=["install-enchant"]
#MISE raw=true
#USAGE flag "--nw" help="Run in terminal mode (no window)"

MISE_ENCHANT_INCLUDE_PATH=$(mise where 'nix:enchant@nixos/nixpkgs#enchant^dev') || { echo "Error: could not find enchant include path"; exit 1; }
MISE_ENCHANT_LIB_PATH=$(mise where 'nix:enchant@nixos/nixpkgs#enchant') || { echo "Error: could not find enchant lib path"; exit 1; }
MISE_VTERM_PATH=$(mise where 'nix:emacsPackages.vterm') || { echo "Error: could not find vterm path"; exit 1; }
export MISE_ENCHANT_INCLUDE_PATH MISE_ENCHANT_LIB_PATH MISE_VTERM_PATH
# This ulimit is mostly for terminal emacs
ulimit -n 10240

EMACS_CMD=$(mise which Emacs)
INIT_DIR="$MISE_PROJECT_ROOT/emacs"
TEST_SCRIPT="$MISE_PROJECT_ROOT/emacs/test-init.el"
RESULTS_FILE="${TMPDIR:-/tmp}/emacs-test-results.txt"

echo "Running Emacs config smoke tests..."
echo "Emacs: $EMACS_CMD"
echo "Init dir: $INIT_DIR"

if [ "$usage_nw" = "true" ]; then
  "$EMACS_CMD" --init-directory="$INIT_DIR" -l "$TEST_SCRIPT" -nw
else
  "$EMACS_CMD" --init-directory="$INIT_DIR" -l "$TEST_SCRIPT"
fi

EXIT_CODE=$?

echo ""
if [ -f "$RESULTS_FILE" ]; then
  echo "=== Results File ==="
  cat "$RESULTS_FILE"
  echo ""
fi

exit $EXIT_CODE
